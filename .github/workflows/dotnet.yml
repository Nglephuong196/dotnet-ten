name: Build and Publish Multiple Projects

on:
    push:
        branches: [master]

jobs:
    build:
        runs-on: ubuntu-latest
        environment: dev

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: '10.0.x'

            # Project 1
            - name: Restore ConsoleApp
              run: dotnet restore ./ConsoleApp/ConsoleApp.csproj

            - name: Build ConsoleApp
              run: dotnet build ./ConsoleApp/ConsoleApp.csproj --configuration Release --no-restore

            - name: Publish ConsoleApp
              run: dotnet publish ./ConsoleApp/ConsoleApp.csproj -c Release -o ./publish/ConsoleApp

            # Project 2
            - name: Restore ononlaw-api
              run: dotnet restore ./ononlaw-api/ononlaw-api.csproj

            - name: Build ononlaw-api
              run: dotnet build ./ononlaw-api/ononlaw-api.csproj --configuration Release --no-restore

            - name: Publish ononlaw-api
              run: dotnet publish ./ononlaw-api/ononlaw-api.csproj -c Release -o ./publish/ononlaw-api

            # Project 3
            - name: Restore WorkerService
              run: dotnet restore ./WorkerService/WorkerService.csproj

            - name: Build WorkerService
              run: dotnet build ./WorkerService/WorkerService.csproj --configuration Release --no-restore

            - name: Publish WorkerService
              run: dotnet publish ./WorkerService/WorkerService.csproj -c Release -o ./publish/WorkerService

            # Upload artifacts separately
            - name: Upload ConsoleApp Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ConsoleApp-build
                  path: ./publish/ConsoleApp

            - name: Upload ononlaw-api Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: project2-build
                  path: ./publish/ononlaw-api

            - name: Upload WorkerService Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: WorkerService-build
                  path: ./publish/WorkerService

            - name: Prepare EC2 directory
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      # Create directory with proper permissions
                      sudo mkdir -p /var/www/myapi
                      sudo chown -R ubuntu:ubuntu /var/www/myapi
                      sudo chmod -R 755 /var/www/myapi

            - name: Copy files to EC2
              uses: appleboy/scp-action@master
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: './publish/ononlaw-api/*'
                  target: '/var/www/myapi'
                  strip_components: 2

            - name: Restart application on EC2
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      # Stop the application
                      sudo systemctl stop myapi || true

                      # Set permissions
                      sudo chown -R ubuntu:ubuntu /var/www/myapi
                      chmod +x /var/www/myapi/*.dll

                      # Start the application
                      sudo systemctl start myapi

                      # Check status
                      sudo systemctl status myapi

                      # Show logs
                      sudo journalctl -u myapi -n 50 --no-pager
